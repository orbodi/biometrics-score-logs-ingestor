# Biometrics Score Logs Ingestor

Middleware de collecte et d'ingestion des logs biomÃ©triques pour la persistance en base de donnÃ©es PostgreSQL.

## ğŸ“‹ Description

Ce projet permet de collecter automatiquement les fichiers de logs biomÃ©triques depuis des serveurs distants via SSH, de les parser pour extraire les scores biomÃ©triques (visage, iris, empreintes), et de les persister dans une base de donnÃ©es PostgreSQL optimisÃ©e pour le reporting BI.

## âœ¨ FonctionnalitÃ©s principales

- ğŸ”„ **Collecte automatisÃ©e** : TÃ©lÃ©chargement des fichiers `.log` depuis plusieurs serveurs SSH
- ğŸ“… **Filtrage par date** : Traitement uniquement des fichiers de la veille et antÃ©rieurs
- ğŸ” **DÃ©duplication robuste** : PrÃ©vention des doublons via SQLite (state) et vÃ©rification des fichiers locaux/archivÃ©s
- ğŸ“ **Parsing structurÃ©** : Extraction des lignes `RqType=IP` (inscriptions biomÃ©triques)
- ğŸ’¾ **Persistance en base** : Insertion des scores dans une table fact optimisÃ©e pour le BI
- ğŸ“Š **Format JSONL** : GÃ©nÃ©ration de fichiers JSONL pour chaque fichier traitÃ©
- ğŸ“¦ **Archivage automatique** : DÃ©placement des fichiers traitÃ©s vers un dossier d'archivage
- ğŸ“‹ **Logging dÃ©taillÃ©** : Logs d'exÃ©cution avec statistiques (fichiers copiÃ©s, parsÃ©s, lignes insÃ©rÃ©es)
- âš™ï¸ **Configuration flexible** : Configuration via fichiers `.env` et JSON

## ğŸš€ Installation

### PrÃ©requis

- Python 3.8+
- PostgreSQL (pour la persistance)
- AccÃ¨s SSH aux serveurs sources des logs

### Installation des dÃ©pendances

```bash
pip install -r requirements.txt
```

### Configuration

1. **Copier le fichier de configuration d'exemple** :
   ```bash
   cp .env.example .env
   ```

2. **Configurer les variables d'environnement** dans `.env` :
   - ParamÃ¨tres de connexion PostgreSQL (host, port, database, user, password, schema)
   - RÃ©pertoires (input, output, archive, logs)
   - Configuration SSH (user, password, timeout)
   - Chemin vers le fichier de configuration des serveurs

3. **Configurer les serveurs SSH** dans `servers.json` (voir `servers.example.json`) :
   ```json
   [
     {
       "name": "server1",
       "host": "192.168.0.10",
       "remote_dir": "/var/log/biometrics"
     }
   ]
   ```

## ğŸ“– Utilisation

### Lancement du processus d'ingestion

```bash
python3 -m ingestor.collect_cli
```

### Workflow d'exÃ©cution

Le programme suit ce workflow automatique :

1. **Initialisation** : CrÃ©ation du schÃ©ma et des tables PostgreSQL si nÃ©cessaire
2. **Ã‰tape 1 - Copie** : Collecte des nouveaux fichiers depuis les serveurs SSH
   - TÃ©lÃ©charge uniquement les fichiers de la veille et antÃ©rieurs
   - VÃ©rifie les doublons (SQLite + fichiers locaux/archivÃ©s)
   - Place les fichiers dans `INPUT_DIR/<server_name>/`
3. **Ã‰tape 2 - Parsing, Persistance et Archivage** :
   - Parse chaque fichier `.log` et extrait les lignes `RqType=IP`
   - GÃ©nÃ¨re un fichier `.jsonl` dans `OUTPUT_JSON_DIR`
   - InsÃ¨re les donnÃ©es dans PostgreSQL (table `biometric_scores`)
   - Archive le fichier `.log` dans `ARCHIVE_DIR`
   - Marque le fichier comme traitÃ© dans SQLite

### RÃ©sumÃ© d'exÃ©cution

Ã€ la fin de chaque exÃ©cution, un rÃ©sumÃ© est affichÃ© dans les logs :

```
=== RÃ‰SUMÃ‰ EXÃ‰CUTION ===
  Fichiers copiÃ©s: 5
  Fichiers parsÃ©s: 3
  Lignes insÃ©rÃ©es en base: 1250
```

## ğŸ—‚ï¸ Structure du projet

```
biometrics-score-logs-ingestor/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ ingestor/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ cli.py              # Configuration du logging
â”‚       â”œâ”€â”€ collect_cli.py      # Point d'entrÃ©e principal
â”‚       â”œâ”€â”€ collector.py        # Collecte SSH des fichiers
â”‚       â”œâ”€â”€ config.py            # Chargement de la configuration
â”‚       â”œâ”€â”€ db.py                # Persistance PostgreSQL (SQLAlchemy)
â”‚       â”œâ”€â”€ models.py            # ModÃ¨les SQLAlchemy
â”‚       â”œâ”€â”€ parser.py            # Parsing des fichiers .log
â”‚       â”œâ”€â”€ processor.py         # Traitement (parsing, JSONL, archivage)
â”‚       â””â”€â”€ state.py             # Gestion du state SQLite
â”œâ”€â”€ .env.example                 # Exemple de configuration
â”œâ”€â”€ servers.example.json         # Exemple de configuration serveurs
â”œâ”€â”€ schema.sql                   # Script SQL de rÃ©fÃ©rence
â”œâ”€â”€ requirements.txt             # DÃ©pendances Python
â””â”€â”€ README                       # Ce fichier
```

## ğŸ—„ï¸ Base de donnÃ©es

### SchÃ©ma configurable

Le schÃ©ma PostgreSQL est configurable via la variable `DB_SCHEMA` dans `.env` (par dÃ©faut: `public`).

### Table `biometric_scores`

Table fact optimisÃ©e pour le reporting BI, avec une ligne par score biomÃ©trique :

- **Contexte transaction** : `re_id`, `re_code`, `rq_type`, `log_date`, `server_name`, `source_file`
- **Dimensions biomÃ©triques** : `modality` (FACE/IRIS/FINGER), `channel` (FACE/LEFT_EYE/RIGHT_EYE/RIGHT_THUMB/...), `sample_id`, `sample_type`
- **Mesures** : `score`, `nbpk` (Nombre de points caractÃ©ristiques pour les empreintes)
- **MÃ©tadonnÃ©es** : `raw_line`, `created_at`

### Initialisation de la base

Le schÃ©ma et les tables sont crÃ©Ã©s automatiquement au premier lancement via la fonction `init_schema()`.

## ğŸ”§ Configuration

### Variables d'environnement (`.env`)

| Variable | Description | DÃ©faut |
|----------|-------------|--------|
| `DB_HOST` | HÃ´te PostgreSQL | `localhost` |
| `DB_PORT` | Port PostgreSQL | `5432` |
| `DB_NAME` | Nom de la base de donnÃ©es | `biometrics` |
| `DB_USER` | Utilisateur PostgreSQL | `biometrics_user` |
| `DB_PASSWORD` | Mot de passe PostgreSQL | - |
| `DB_SCHEMA` | SchÃ©ma PostgreSQL | `public` |
| `LOG_LEVEL` | Niveau de logging | `INFO` |
| `INPUT_DIR` | RÃ©pertoire des fichiers collectÃ©s | `inputs` |
| `OUTPUT_JSON_DIR` | RÃ©pertoire des fichiers JSONL | `outputs` |
| `ARCHIVE_DIR` | RÃ©pertoire d'archivage | `archive` |
| `EXECUTION_LOG_DIR` | RÃ©pertoire des logs d'exÃ©cution | `logs` |
| `STATE_DB_PATH` | Chemin du fichier SQLite de state | `state/ingestor_state.db` |
| `SSH_SERVERS_FILE` | Fichier JSON des serveurs | `servers.example.json` |
| `SSH_USER` | Utilisateur SSH | - |
| `SSH_PASSWORD` | Mot de passe SSH | - |
| `SSH_TIMEOUT` | Timeout SSH (secondes) | `30` |

### Fichier de configuration des serveurs (`servers.json`)

Format JSON avec la liste des serveurs :

```json
[
  {
    "name": "server1",
    "host": "192.168.0.10",
    "remote_dir": "/var/log/biometrics"
  }
]
```

## ğŸ“Š Format des donnÃ©es

### Format d'entrÃ©e (`.log`)

Lignes avec `RqType=IP` contenant les scores biomÃ©triques :
```
RqType=IP ReId=ABC123 ... FaceSampleId=1 FaceScore=85 ... LeftEyeScore=90 RightEyeScore=88 ...
```

### Format de sortie (`.jsonl`)

Fichiers JSONL avec un objet JSON par ligne :

```json
{
  "rq_type": "IP",
  "re_id": "ABC123",
  "re_code": 0,
  "face": {
    "sample_id": 1,
    "sample_type": "STILL",
    "score": 85
  },
  "iris": {
    "sample_id": 1,
    "left": 90,
    "right": 88
  },
  "fingerprints": [
    {
      "sample_id": 1,
      "sample_type": "TENPRINT_SLAP",
      "fingers": {
        "right_thumb": {"score": 92, "nbpk": 45},
        ...
      }
    }
  ]
}
```

## ğŸ”’ SÃ©curitÃ©

- Les identifiants SSH et les mots de passe de base de donnÃ©es sont stockÃ©s dans `.env` (Ã  ne pas commiter)
- Le fichier `.env` est ignorÃ© par Git (voir `.gitignore`)
- Validation des noms de schÃ©ma PostgreSQL pour Ã©viter l'injection SQL

## ğŸ“ Logs

Les logs d'exÃ©cution sont gÃ©nÃ©rÃ©s dans `EXECUTION_LOG_DIR` avec des fichiers horodatÃ©s :
- `copie_logs_YYYYMMDD_HHMMSS.log` : Logs de la phase de copie
- `parsing_logs_YYYYMMDD_HHMMSS.log` : Logs de la phase de parsing/persistance/archivage

## ğŸ§ª Tests

```bash
# ExÃ©cuter les tests
python -m pytest tests/
```

## ğŸ“„ Licence

[Ã€ complÃ©ter selon votre licence]
